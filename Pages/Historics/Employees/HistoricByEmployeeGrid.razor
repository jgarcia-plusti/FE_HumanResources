@page "/historicEmployee/{uuid}-{name}"
@using System.Net.Http.Headers
@using FE_HumanResources.Models
@using FE_HumanResources.Entities
@using System.Reflection
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject ContextMenuService ContextMenuService
@inject DialogService DialogService

<RadzenBody Gap="1rem" Class="rz-p-sm-12" Style="height:100vh; overflow-y:auto;">
    <RadzenBreadCrumb>
        <Template Context="item">
            <RadzenBadge Text="@item.Text" IsPill="true" />
        </Template>
        <ChildContent>
            <RadzenBreadCrumbItem Path="/" Text="Employee" />
            <RadzenBreadCrumbItem Path="/" Text="@name" />
            <RadzenBreadCrumbItem Path="/employesgrid" Text="Histórico del Empleado" />
        </ChildContent>
    </RadzenBreadCrumb>
    <br />
    <RadzenButton Text="Actualizar" Click="@Reset" Style="margin-bottom: 20px;" />
    <br />
    <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Simple"
                    AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                    Data="@historicModel" TItem="HistoricEmployeEntity" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or"
                    FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    SelectionMode="DataGridSelectionMode.Single" @bind-Value=@selectedHistorics CellContextMenu="@OnCellContextMenu">
        <Columns>
            <RadzenDataGridColumn TItem="HistoricEmployeEntity" Property="ActionType" Title="Tipo de Accion" Frozen="true" Width="160px" />
            <RadzenDataGridColumn TItem="HistoricEmployeEntity" Property="Module" Title="Descripción" Frozen="true" Width="160px" />
            <RadzenDataGridColumn TItem="HistoricEmployeEntity" Property="NameEmployee" Title="Empleado Modificado" Width="160px" />
            <RadzenDataGridColumn TItem="HistoricEmployeEntity" Property="Date" Title="Fecha" FormatString="{0:d}" Width="200px" />
            <RadzenDataGridColumn TItem="HistoricEmployeEntity" Property="UserName" Title="Usuario" Width="300px" />
        </Columns>
    </RadzenDataGrid>
    <br />
    <RadzenButton Text="Regresar" Click="@GoBack" Style="margin-bottom: 20px;" />
</RadzenBody>

@code {
    [Parameter]
    public string uuid { get; set; }
    [Parameter]
    public string name { get; set; }

    private IEnumerable<HistoricEmployeEntity> historicModel;
    private IList<HistoricEmployeEntity> selectedHistorics;
    EmployeeEntity newEmploye;
    EmployeeEntity oldEmploye;
    Dictionary<string, (object, object)> differences = new Dictionary<string, (object, object)>();

    protected override async Task OnInitializedAsync()
    {
        StateHasChanged();
        await base.OnInitializedAsync();
        await Reset();
    }

    private async Task Reset()
    {
        string? jwt = await LocalStorage.GetItemAsync<string>("jwt");
        if (!string.IsNullOrEmpty(jwt))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwt);
            HttpResponseMessage response = await Http.PostAsJsonAsync("api/Employee/GetHistoricByEmployee", new PayloadGeneric()
                {
                    Uuid = this.uuid,
                    payload = new { uuid = this.uuid }
                });
            if (response.IsSuccessStatusCode)
            {
                string content = response.Content.ReadAsStringAsync().Result;
                historicModel = JsonConvert.DeserializeObject<IEnumerable<HistoricEmployeEntity>>(content);
                if (historicModel == null)
                {

                }
                else
                    selectedHistorics = new List<HistoricEmployeEntity>() { historicModel.FirstOrDefault() };
            }
            else
            {
                await LocalStorage.ClearAsync();
                NavigationManager.NavigateTo("login", true);
            }

        }
        else
        {
            await LocalStorage.ClearAsync();
            NavigationManager.NavigateTo("login", true);
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/employesgrid");
    }

    void OnCellContextMenu(DataGridCellMouseEventArgs<HistoricEmployeEntity> args)
    {
        selectedHistorics = new List<HistoricEmployeEntity>() { args.Data };

        ContextMenuService.Open(args,
            new List<ContextMenuItem> {
                new ContextMenuItem(){ Text = "Ver", Value = 1, Icon = "search" }
                },
            (e) =>
            {
                if (e.Value.ToString() == "1")
                {
                    this.newEmploye = JsonConvert.DeserializeObject<EmployeeEntity>(args.Data.NewRegister);
                    this.oldEmploye = JsonConvert.DeserializeObject<EmployeeEntity>(args.Data.OldRegister);

                    differences = Getdifferences(newEmploye, oldEmploye);
                    ShowInLinedialog();
                }
            }
         );
    }

    private async Task ShowInLinedialog()
    {
        var result = await DialogService.OpenAsync("Comparación del registro", ds =>
            @<RadzenStack Gap="1.5rem">
                <RadzenColumn Size="12">
                    @foreach(var diff in differences)
                    {
                        <RadzenRow AlignItems="AlignItems.Center">
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="@diff.Key" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="@diff.Value.Item2.ToString()" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenLabel Text="@diff.Value.Item1.ToString()" />
                            </RadzenColumn>
                        </RadzenRow>
                    }
                </RadzenColumn>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal">
                        <RadzenButton Text="Ok" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Danger" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
            );
    }

    private static Dictionary<string, (object Value1, object Value2)> Getdifferences<T>(T object1, T object2)
    {
        var differences = new Dictionary<string, (object, object)>();

        PropertyInfo[] properties = typeof(T).GetProperties();

        foreach (var property in properties)
        {
            var value1 = property.GetValue(object1);
            var value2 = property.GetValue(object2);

            if (!Equals(value1, value2))
            {
                differences.Add(property.Name, (value1, value2));
            }
        }

        return differences;
    }


}

