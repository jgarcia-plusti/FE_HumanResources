@page "/usersgrid"
@using System.Net.Http.Headers
@using FE_HumanResources.Models
@using FE_HumanResources.Entities
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject ContextMenuService ContextMenuService
@inject AuthenticationStateProvider AuthStateProvider

<RadzenBody Gap="1rem" Class="rz-p-sm-12" Style="height:100vh; overflow-y:auto;">
    <RadzenBreadCrumb>
        <Template Context="item">
            <RadzenBadge Text="@item.Text" IsPill="true" />
        </Template>
        <ChildContent>
            <RadzenBreadCrumbItem Path="/" Text="Usuarios" />
            <RadzenBreadCrumbItem Path="/usersgrid" Text="Lista de Usuarios" />
        </ChildContent>
    </RadzenBreadCrumb>
    <br>
    <RadzenButton Text="Actualizar" Click="@Reset" Style="margin-bottom: 20px;" />
    <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false"
        FilterMode="FilterMode.Simple" AllowSorting="true" PageSize="10" AllowPaging="true"
        PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true" Data="@UserEntity" TItem="UserEntity"
        ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or"
        SelectionMode="DataGridSelectionMode.Single" @bind-Value=@selectedUser CellContextMenu="@OnCellContextMenu"
        FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive">
        <Columns>
            <RadzenDataGridColumn TItem="UserEntity" Property="UserName" Title="Nombre" Frozen="true" Width="80px"
                TextAlign="TextAlign.Center" />
            <RadzenDataGridColumn TItem="UserEntity" Property="LastName" Title="Apellido" Frozen="true" Width="160px" />
            <RadzenDataGridColumn TItem="UserEntity" Property="Identification" Title="Identificación" Width="160px" />
            <RadzenDataGridColumn TItem="UserEntity" Property="Phone" Title="Teléfono" FormatString="{0:d}"
                Width="200px" />
            <RadzenDataGridColumn TItem="UserEntity" Property="Email" Title="Correo" Width="300px" />
        </Columns>
    </RadzenDataGrid>
</RadzenBody>


@code {
    private UserEntity user = new UserEntity();
    private IEnumerable<UserEntity> UserEntity;
    private IList<UserEntity> selectedUser;
    private string uuidRole = "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Reset();
    }

    private async Task Reset()
    {
        string? jwt = await LocalStorage.GetItemAsync<string>("jwt");
        uuidRole = await LocalStorage.GetItemAsync<string>("uuidRole");

        if (!string.IsNullOrEmpty(jwt))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwt);
            HttpResponseMessage response = await Http.GetAsync("api/User/GetAll");
            if (response.IsSuccessStatusCode)
            {
                string content = response.Content.ReadAsStringAsync().Result;
                UserEntity = JsonConvert.DeserializeObject<IEnumerable<UserEntity>>(content);
                if (UserEntity == null)
                {

                }
                else
                    selectedUser = UserEntity.Take(1).ToList();
            }
            else
            {
                await LocalStorage.ClearAsync();
                NavigationManager.NavigateTo("login", true);
            }
        }
        else
        {
            await LocalStorage.ClearAsync();
            NavigationManager.NavigateTo("login", true);
        }
    }

    async Task OnCellContextMenu(DataGridCellMouseEventArgs<UserEntity> args)
    {
        selectedUser = new List<UserEntity>() { args.Data };

        var contextMenuItems = new List<ContextMenuItem>
        {
            new ContextMenuItem() { Text = "Ver", Value = 4, Icon = "visibility" }
        };

        if (await UserIsInRole("0A8A30E0-1793-4C2A-95B3-A8AB44D9D23F") || await UserIsInRole("1A60AA0C-4DE7-4964-AF65-92409A85788E") || await UserIsInRole("637D8DF2-4E4F-4CB8-B0F9-B12C66A6C364"))
        {
            contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Editar", Value = 1, Icon = "search" });
        }

        if (await UserIsInRole("1A60AA0C-4DE7-4964-AF65-92409A85788E") || await UserIsInRole("637D8DF2-4E4F-4CB8-B0F9-B12C66A6C364"))
        {
            contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Eliminar", Value = 3, Icon = "info" });
            contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Ver Histórico del Registro", Value = 2, Icon = "home" });
        }

        ContextMenuService.Open(args,
        contextMenuItems,
        (e) =>
        {
            if (e.Value.ToString() == "1")
            {
                NavigationManager.NavigateTo($"/User/{args.Data.Uuid}");
            }
            else if (e.Value.ToString() == "2")
            {
                NavigationManager.NavigateTo($"/historicusergrid/{args.Data.Uuid}-{args.Data.UserName}");
            }
            else if (e.Value.ToString() == "4")
            {
                NavigationManager.NavigateTo($"/User/{args.Data.Uuid}/{true}");
            }
        }
        );
    }

    private async Task<bool> UserIsInRole(string uuidRole)
    {
        // Implementa la lógica para verificar si el usuario actual pertenece a un rol específico
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        return user.IsInRole(uuidRole);
    }
}
