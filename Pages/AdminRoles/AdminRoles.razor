@page "/AdminRoles"
@using System.Net.Http.Headers
@using FE_HumanResources.Models
@using FE_HumanResources.Entities
@inject ILocalStorageService LocalStorage
@inject ContextMenuService ContextMenuService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http

<RadzenBody Gap="1rem" Class="rz-p-sm-12">
    <RadzenBreadCrumb>
        <Template Context="item">
            <RadzenBadge Text="@item.Text" IsPill="true" />
        </Template>
        <ChildContent>
            <RadzenBreadCrumbItem Path="/" Text="Empleados" />
            <RadzenBreadCrumbItem Path="/usersgrid" Text="Lista de Empleados" />
        </ChildContent>
    </RadzenBreadCrumb>
    <br />
    <RadzenButton Text="Crear" Click="@Create" Style="margin-bottom: 20px;" />
    <RadzenButton Text="Actualizar" Click="@Reset" Style="margin-bottom: 20px;" />
    <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Simple"
                    AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                    Data="@Roles" TItem="RoleEntity" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or"
                    SelectionMode="DataGridSelectionMode.Single" @bind-Value=@selectedRole CellContextMenu="@OnCellContextMenu"
                    FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive">
        <Columns>
            <RadzenDataGridColumn TItem="RoleEntity" Property="Name" Title="Nombre" Frozen="true" TextAlign="TextAlign.Center" />
            <RadzenDataGridColumn TItem="RoleEntity" Property="Description" Title="Descripcion" Frozen="true" />

        </Columns>
    </RadzenDataGrid>
</RadzenBody>


@code {
    IEnumerable<RoleEntity> Roles;
    IList<RoleEntity> selectedRole;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Reset();
    }

    private async Task Reset()
    {
        string? jwt = await LocalStorage.GetItemAsync<string>("jwt");
        if (!string.IsNullOrEmpty(jwt))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwt);
            HttpResponseMessage response = await Http.GetAsync("api/Catalogs/Roles");

            if (response.IsSuccessStatusCode)
            {
                string content = response.Content.ReadAsStringAsync().Result;
                Roles = JsonConvert.DeserializeObject<ICollection<RoleEntity>>(content);
                if (Roles == null)
                    showError();
            }
        }
        StateHasChanged();
    }

    private async Task Create()
    {
        NavigationManager.NavigateTo("/CreateRole");
    }

    private void showError(string messageInfo = null)
    {
        if (string.IsNullOrEmpty(messageInfo))
            messageInfo = $"Perdon algo salio mal!";

        NotificationService.Notify(new NotificationMessage()
            {
                Severity = NotificationSeverity.Error,
                Summary = messageInfo,
                Duration = 4000
            });
    }

    private void showInfo(string msg)
    {
        string messageInfo = msg;
        NotificationService.Notify(new NotificationMessage()
            {
                Severity = NotificationSeverity.Info,
                Summary = messageInfo,
                Duration = 4000
            });
    }

    async Task OnCellContextMenu(DataGridCellMouseEventArgs<RoleEntity> args)
    {
        selectedRole = new List<RoleEntity>() { args.Data };

        var contextMenuItems = new List<ContextMenuItem>
        {
            new ContextMenuItem() { Text = "Editar", Value = 4, Icon = "visibility" }
        };

        // if (await UserIsInRole("0A8A30E0-1793-4C2A-95B3-A8AB44D9D23F") || await UserIsInRole("1A60AA0C-4DE7-4964-AF65-92409A85788E") || await UserIsInRole("637D8DF2-4E4F-4CB8-B0F9-B12C66A6C364"))
        // {
        //     contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Editar", Value = 1, Icon = "search" });

        // }
        // if (await UserIsInRole("1A60AA0C-4DE7-4964-AF65-92409A85788E") || await UserIsInRole("637D8DF2-4E4F-4CB8-B0F9-B12C66A6C364"))
        // {
        //     contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Ver Histórico del Registro", Value = 2, Icon = "home" });
        //     contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Ver Pagos", Value = 3, Icon = "account_balance_wallet" });
        //     contextMenuItems.Insert(0, new ContextMenuItem() { Text = "Eliminar", Value = 4, Icon = "info" });
        // }

        ContextMenuService.Open(args,
            contextMenuItems,
            (e) =>
            {
                if (e.Value.ToString() == "1")
                {
                    
                }
                else if (e.Value.ToString() == "2")
                {
                    
                }
                else if (e.Value.ToString() == "4")
                {
                    NavigationManager.NavigateTo($"UpdateRole/{args.Data.Uuid}");
                }
            }
         );
    }

}
